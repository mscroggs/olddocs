

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>19. Stokes equations &mdash; FEniCS Project</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../search.html"/>
    <link rel="top" title="FEniCS Project" href="../../../../index.html"/>
        <link rel="up" title="Collection of documented demos" href="../../../index.html"/>
        <link rel="next" title="20. Stokes equations with Mini elements" href="../../stokes-mini/python/documentation.html"/>
        <link rel="prev" title="18. Singular Poisson" href="../../singular-poisson/python/documentation.html"/> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> DOLFIN
          

          
          </a>

          
            
            
              <div class="version">
                1.4.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../programmers-reference/index.html">Programmer&#8217;s reference for DOLFIN (Python)</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Collection of documented demos</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../auto-adaptive-poisson/python/documentation.html">1. Auto adaptive Poisson equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../bcs/python/documentation.html">2. Set boundary conditions for meshes that include boundary indicators</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../biharmonic/python/documentation.html">3. Biharmonic equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../built-in_meshes/python/documentation.html">4. Built-in meshes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cahn-hilliard/python/documentation.html">5. Cahn-Hilliard equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../csg-2D/python/documentation.html">6. Create CSG 2D-geometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../csg-3D/python/documentation.html">7. Create CSG 3D-geometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../eigenvalue/python/documentation.html">8. A simple eigenvalue solver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../hyperelasticity/python/documentation.html">9. Hyperelasticity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mesh-generation/python/documentation.html">10. Generate mesh</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mixed-poisson-dual/python/documentation.html">11. Dual-mixed formulation for Poisson equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../mixed-poisson/python/documentation.html">12. Mixed formulation for Poisson equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../navier-stokes/python/documentation.html">13. Incompressible Navier-Stokes equations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../neumann-poisson/python/documentation.html">14. Poisson equation with pure Neumann boundary conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../nonlinear-poisson/python/documentation.html">15. Nonlinear Poisson equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../periodic/python/documentation.html">16. Poisson equation with periodic boundary conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../poisson/python/documentation.html">17. Poisson equation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../singular-poisson/python/documentation.html">18. Singular Poisson</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">19. Stokes equations</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#strong-form-of-the-stokes-equations">19.1. Strong form of the Stokes equations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#weak-form-of-the-stokes-equations">19.2. Weak form of the Stokes equations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#preconditioning-of-the-linear-system-of-equations">19.3. Preconditioning of the linear system of equations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#domain-and-boundary-conditions">19.4. Domain and boundary conditions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#implementation">19.5. Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#complete-code">19.6. Complete code</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../stokes-mini/python/documentation.html">20. Stokes equations with Mini elements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../stokes-stabilized/python/documentation.html">21. Stokes equations with stabilized first order elements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../stokes-taylor-hood/python/documentation.html">22. Stokes equations with Taylor-Hood elements</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subdomains-poisson/python/documentation.html">23. Poisson equation with multiple subdomains</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../subdomains/python/documentation.html">24. Marking subdomains of a mesh</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tensor-weighted-poisson/python/documentation.html">25. Tensor-weighted Poisson</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quick_reference.html">Quick Programmer&#8217;s Reference (Python)</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../index.html">DOLFIN</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../index.html">Collection of documented demos</a> &raquo;</li>
      
    <li>19. Stokes equations</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../../_sources/demo/documented/stokes-iterative/python/documentation.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="stokes-equations">
<span id="demo-pde-iterative-stokes-python-documentation"></span><h1>19. Stokes equations<a class="headerlink" href="#stokes-equations" title="Permalink to this headline">¶</a></h1>
<p>This demo is implemented in a single Python file,
<a class="reference download internal" href="../../../../_downloads/demo_stokes-iterative.py" download=""><code class="xref download docutils literal"><span class="pre">demo_stokes-iterative.py</span></code></a>, which contains both the
variational forms and the solver.</p>
<p>This demo illustrates how to:</p>
<ul class="simple">
<li>Maintain symmetry when assembling a system of symmetric equations
with essential (Dirichlet) boundary conditions</li>
<li>Use a iterative solver explicitly for solving a linear system of equations</li>
<li>Define a preconditioner explicitly using a form</li>
</ul>
<div class="section" id="strong-form-of-the-stokes-equations">
<h2>19.1. Strong form of the Stokes equations<a class="headerlink" href="#strong-form-of-the-stokes-equations" title="Permalink to this headline">¶</a></h2>
<p>The incompressible Stokes equations in strong form read: for a domain
<span class="math">\(\Omega \subset \mathbb{R}^n\)</span>, find the velocity <span class="math">\(u\)</span> and
the pressure <span class="math">\(p\)</span> satisfying</p>
<div class="math">
\[\begin{split}- \nabla \cdot (\nabla u + p I) &amp;= f \quad {\rm in} \ \Omega, \\
                 \nabla \cdot u &amp;= 0 \quad {\rm in} \ \Omega. \\\end{split}\]</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The sign of the pressure has been flipped from the classical
definition. This is done in order to have a symmetric (but not
positive-definite) system of equations rather than a non-symmetric
(but positive-definite) system of equations.</p>
</div>
<p>A typical set of boundary conditions on the boundary <span class="math">\(\partial
\Omega = \Gamma_{D} \cup \Gamma_{N}\)</span> can be:</p>
<div class="math">
\[\begin{split}u &amp;= u_0 \quad {\rm on} \ \Gamma_{D}, \\
\nabla u \cdot n + p n &amp;= g   \quad {\rm on} \ \Gamma_{N}. \\\end{split}\]</div>
</div>
<div class="section" id="weak-form-of-the-stokes-equations">
<h2>19.2. Weak form of the Stokes equations<a class="headerlink" href="#weak-form-of-the-stokes-equations" title="Permalink to this headline">¶</a></h2>
<p>The Stokes equations can easily formulated in a mixed variational
form; that is, a form where the two variables, the velocity and the
pressure, are approximated simultaneously. Using the abstract
framework, we have the problem: find <span class="math">\((u, p) \in W\)</span> such that</p>
<div class="math">
\[a((u, p), (v, q)) = L((v, q))\]</div>
<p>for all <span class="math">\((v, q) \in W\)</span> where</p>
<div class="math">
\[\begin{split}a((u, p), (v, q))
&amp;= \int_{\Omega} \nabla u \cdot \nabla v
                 + \nabla \cdot v \ p
                 + \nabla \cdot u \ q \, {\rm d} x, \\
L((v, q))
&amp;= \int_{\Omega} f \cdot v \, {\rm d} x
   + \int_{\partial \Omega_N} g \cdot v \, {\rm d} s. \\\end{split}\]</div>
<p>The space <cite>W</cite> should be a mixed (product) function space: <span class="math">\(W = V
\times Q\)</span> such that <span class="math">\(u \in V\)</span> and <span class="math">\(q \in Q\)</span>.</p>
</div>
<div class="section" id="preconditioning-of-the-linear-system-of-equations">
<h2>19.3. Preconditioning of the linear system of equations<a class="headerlink" href="#preconditioning-of-the-linear-system-of-equations" title="Permalink to this headline">¶</a></h2>
<p>For the resulting linear system of equations, the following form
defines a suitable preconditioner:</p>
<div class="math">
\[b((u, p), (v, q)) = \int_{\Omega} \nabla u \cdot \nabla v + p \, q \, {\rm d} x\]</div>
</div>
<div class="section" id="domain-and-boundary-conditions">
<h2>19.4. Domain and boundary conditions<a class="headerlink" href="#domain-and-boundary-conditions" title="Permalink to this headline">¶</a></h2>
<p>In this demo, we shall consider the following definitions of the input
functions, the domain, and the boundaries:</p>
<ul class="simple">
<li><span class="math">\(\Omega = [0,1]^3\)</span>  (a unit cube)</li>
<li><span class="math">\(\Omega_D = \{(x_0, x_1, x_2) \, | \, x_0 = 0 \, \text{or} \,
x_0 = 1 \, \text{or} \, x_1 = 0 \, \text{or} \, x_1 = 1 \}\)</span></li>
<li><span class="math">\(u_0 = (- \sin(\pi x_1), 0.0, 0.0)\)</span> for <span class="math">\(x_0 = 1\)</span> and
<span class="math">\(u_0 = (0.0, 0.0, 0.0)\)</span> otherwise</li>
<li><span class="math">\(f = (0.0, 0.0, 0.0)\)</span></li>
<li><span class="math">\(g = (0.0, 0.0, 0.0)\)</span></li>
</ul>
</div>
<div class="section" id="implementation">
<h2>19.5. Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<p>This description goes through the implementation (in
<a class="reference download internal" href="../../../../_downloads/demo_stokes-iterative.py" download=""><code class="xref download docutils literal"><span class="pre">demo_stokes-iterative.py</span></code></a>) of a solver for the above
described Stokes equations. Some of the standard steps will be
described in less detail, so before reading this, we suggest that you
are familiarize with the <a class="reference internal" href="../../poisson/python/documentation.html#demo-pde-poisson-python-documentation"><span class="std std-ref">Poisson demo</span></a> (for the very basics) and the
<a class="reference internal" href="../../mixed-poisson/python/documentation.html#demo-pde-mixed-poisson-python-documentation"><span class="std std-ref">Mixed Poisson demo</span></a> (for how to deal with
mixed function spaces). Also, the <a class="reference internal" href="../../navier-stokes/python/documentation.html#demo-pde-navier-stokes-python-documentation"><span class="std std-ref">Navier&#8211;Stokes demo</span></a> illustrates how to use
iterative solvers in a more implicit manner (typically only suitable
for positive-definite systems of equations).</p>
<p>The Stokes equations as formulated above result in a system of linear
equations that is not positive-definite. Standard iterative linear
solvers typically fail to converge for such systems. Some care must
therefore be taken in preconditioning the systems of
equations. Moreover, not all of the linear algebra backends support
this. We therefore start by checking that either &#8220;PETSc&#8221; or &#8220;Epetra&#8221;
(from Trilinos) is available. We also try to pick MINRES Krylov
subspace method which is suitable for symmetric indefinite problems.
If not available, costly QMR method is choosen.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dolfin</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1"># Test for PETSc or Epetra</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">has_linear_algebra_backend</span><span class="p">(</span><span class="s2">&quot;PETSc&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_linear_algebra_backend</span><span class="p">(</span><span class="s2">&quot;Epetra&quot;</span><span class="p">):</span>
    <span class="n">info</span><span class="p">(</span><span class="s2">&quot;DOLFIN has not been configured with Trilinos or PETSc. Exiting.&quot;</span><span class="p">)</span>
    <span class="nb">exit</span><span class="p">()</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">has_krylov_solver_preconditioner</span><span class="p">(</span><span class="s2">&quot;amg&quot;</span><span class="p">):</span>
    <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sorry, this demo is only available when DOLFIN is compiled with AMG &quot;</span>
         <span class="s2">&quot;preconditioner, Hypre or ML.&quot;</span><span class="p">)</span>
    <span class="nb">exit</span><span class="p">()</span>

<span class="k">if</span> <span class="n">has_krylov_solver_method</span><span class="p">(</span><span class="s2">&quot;minres&quot;</span><span class="p">):</span>
    <span class="n">krylov_method</span> <span class="o">=</span> <span class="s2">&quot;minres&quot;</span>
<span class="k">elif</span> <span class="n">has_krylov_solver_method</span><span class="p">(</span><span class="s2">&quot;tfqmr&quot;</span><span class="p">):</span>
    <span class="n">krylov_method</span> <span class="o">=</span> <span class="s2">&quot;tfqmr&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Default linear algebra backend was not compiled with MINRES or TFQMR &quot;</span>
         <span class="s2">&quot;Krylov subspace method. Terminating.&quot;</span><span class="p">)</span>
    <span class="nb">exit</span><span class="p">()</span>
</pre></div>
</div>
<p>Next, we define the mesh (a <code class="xref py py-class docutils literal"><span class="pre">UnitCubeMesh</span></code>) and a <a class="reference internal" href="../../../../programmers-reference/functions/functionspace/MixedFunctionSpace.html#dolfin.functions.functionspace.MixedFunctionSpace" title="dolfin.functions.functionspace.MixedFunctionSpace"><code class="xref py py-class docutils literal"><span class="pre">MixedFunctionSpace</span></code></a> composed of a
<a class="reference internal" href="../../../../programmers-reference/functions/functionspace/VectorFunctionSpace.html#dolfin.functions.functionspace.VectorFunctionSpace" title="dolfin.functions.functionspace.VectorFunctionSpace"><code class="xref py py-class docutils literal"><span class="pre">VectorFunctionSpace</span></code></a> of continuous
piecewise quadratics and a <a class="reference internal" href="../../../../programmers-reference/functions/functionspace/FunctionSpace.html#dolfin.functions.functionspace.FunctionSpace" title="dolfin.functions.functionspace.FunctionSpace"><code class="xref py py-class docutils literal"><span class="pre">FunctionSpace</span></code></a> of continuous
piecewise linears. (This mixed finite element space is known as the
Taylor&#8211;Hood elements and is a stable, standard element pair for the
Stokes equations.)</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Load mesh</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">UnitCubeMesh</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

<span class="c1"># Define function spaces</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">VectorFunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">V</span> <span class="o">*</span> <span class="n">Q</span>
</pre></div>
</div>
<p>Next, we define the boundary conditions.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Boundaries</span>
<span class="k">def</span> <span class="nf">right</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">DOLFIN_EPS</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">left</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">DOLFIN_EPS</span>
<span class="k">def</span> <span class="nf">top_bottom</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">DOLFIN_EPS</span> <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">DOLFIN_EPS</span>

<span class="c1"># No-slip boundary condition for velocity</span>
<span class="n">noslip</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
<span class="n">bc0</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">noslip</span><span class="p">,</span> <span class="n">top_bottom</span><span class="p">)</span>

<span class="c1"># Inflow boundary condition for velocity</span>
<span class="n">inflow</span> <span class="o">=</span> <span class="n">Expression</span><span class="p">((</span><span class="s2">&quot;-sin(x[1]*pi)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0&quot;</span><span class="p">))</span>
<span class="n">bc1</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">inflow</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>

<span class="c1"># Boundary condition for pressure at outflow</span>
<span class="n">zero</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">bc2</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">zero</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>

<span class="c1"># Collect boundary conditions</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">bc0</span><span class="p">,</span> <span class="n">bc1</span><span class="p">,</span> <span class="n">bc2</span><span class="p">]</span>
</pre></div>
</div>
<p>The bilinear and linear forms corresponding to the weak mixed
formulation of the Stokes equations are defined as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Define variational problem</span>
<span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">TrialFunctions</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
<span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">TestFunctions</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">*</span><span class="n">dx</span> <span class="o">+</span> <span class="n">div</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">dx</span> <span class="o">+</span> <span class="n">q</span><span class="o">*</span><span class="n">div</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
<span class="n">L</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
</pre></div>
</div>
<p>We can now use the same <a class="reference internal" href="../../../../programmers-reference/functions/function/TrialFunction.html#dolfin.functions.function.TrialFunction" title="dolfin.functions.function.TrialFunction"><code class="xref py py-class docutils literal"><span class="pre">TrialFunctions</span></code></a> and
<a class="reference internal" href="../../../../programmers-reference/functions/function/TestFunction.html#dolfin.functions.function.TestFunction" title="dolfin.functions.function.TestFunction"><code class="xref py py-class docutils literal"><span class="pre">TestFunctions</span></code></a> to
define the preconditioner matrix. We first define the form
corresponding to the expression for the preconditioner (given in the
initial description above):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Form for use in constructing preconditioner matrix</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">*</span><span class="n">dx</span> <span class="o">+</span> <span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">dx</span>
</pre></div>
</div>
<p>Next, we want to assemble the matrix corresponding to the bilinear
form and the vector corresponding to the linear form of the Stokes
equations. Moreover, we want to apply the specified boundary
conditions to the linear system. However, <a class="reference internal" href="../../../../programmers-reference/fem/assembling/assemble.html#dolfin.fem.assembling.assemble" title="dolfin.fem.assembling.assemble"><code class="xref py py-func docutils literal"><span class="pre">assembling</span></code></a> the matrix and vector and applying a
<a class="reference internal" href="../../../../programmers-reference/fem/bcs/DirichletBC.html#dolfin.fem.bcs.DirichletBC" title="dolfin.fem.bcs.DirichletBC"><code class="xref py py-func docutils literal"><span class="pre">DirichletBC</span></code></a> separately
will possibly result in a non-symmetric system of equations. Instead,
we can use the <a class="reference internal" href="../../../../programmers-reference/fem/assembling/assemble_system.html#dolfin.fem.assembling.assemble_system" title="dolfin.fem.assembling.assemble_system"><code class="xref py py-func docutils literal"><span class="pre">assemble_system</span></code></a> function to assemble both the
matrix <code class="docutils literal"><span class="pre">A</span></code>, the vector <code class="docutils literal"><span class="pre">bb</span></code>, and apply the boundary conditions
<code class="docutils literal"><span class="pre">bcs</span></code> in a symmetric fashion:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Assemble system</span>
<span class="n">A</span><span class="p">,</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">assemble_system</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">bcs</span><span class="p">)</span>
</pre></div>
</div>
<p>We do the same for the preconditioner matrix <code class="docutils literal"><span class="pre">P</span></code> using the linear
form <code class="docutils literal"><span class="pre">L</span></code> as a dummy form:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Assemble preconditioner system</span>
<span class="n">P</span><span class="p">,</span> <span class="n">btmp</span> <span class="o">=</span> <span class="n">assemble_system</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">bcs</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, we specify the iterative solver we want to use, in this case a
<code class="xref py py-class docutils literal"><span class="pre">KrylovSolver</span></code>. We associate the
left-hand side matrix <code class="docutils literal"><span class="pre">A</span></code> and the preconditioner matrix <code class="docutils literal"><span class="pre">P</span></code> with
the solver by calling <code class="xref py py-func docutils literal"><span class="pre">solver.set_operators</span></code>.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Create Krylov solver and AMG preconditioner</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">KrylovSolver</span><span class="p">(</span><span class="n">krylov_method</span><span class="p">,</span> <span class="s2">&quot;amg&quot;</span><span class="p">)</span>

<span class="c1"># Associate operator (A) and preconditioner matrix (P)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">set_operators</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
</pre></div>
</div>
<p>We are now almost ready to solve the linear system of equations. It
remains to specify a <code class="xref py py-class docutils literal"><span class="pre">Vector</span></code> for
storing the result. For easy manipulation later, we can define a
<a class="reference internal" href="../../../../programmers-reference/functions/function/Function.html#dolfin.functions.function.Function" title="dolfin.functions.function.Function"><code class="xref py py-class docutils literal"><span class="pre">Function</span></code></a> and use the
vector associated with this Function. The call to
<code class="xref py py-func docutils literal"><span class="pre">solver.solve</span></code> then looks as
follows</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Solve</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">vector</span><span class="p">(),</span> <span class="n">bb</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we can play with the result in different ways:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Get sub-functions</span>
<span class="n">u</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="c1"># Save solution in VTK format</span>
<span class="n">ufile_pvd</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s2">&quot;velocity.pvd&quot;</span><span class="p">)</span>
<span class="n">ufile_pvd</span> <span class="o">&lt;&lt;</span> <span class="n">u</span>
<span class="n">pfile_pvd</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s2">&quot;pressure.pvd&quot;</span><span class="p">)</span>
<span class="n">pfile_pvd</span> <span class="o">&lt;&lt;</span> <span class="n">p</span>

<span class="c1"># Plot solution</span>
<span class="n">plot</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="complete-code">
<h2>19.6. Complete code<a class="headerlink" href="#complete-code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default"><div class="highlight"><pre><span></span>
<span class="kn">from</span> <span class="nn">dolfin</span> <span class="k">import</span> <span class="o">*</span>

<span class="c1"># Test for PETSc or Epetra</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">has_linear_algebra_backend</span><span class="p">(</span><span class="s2">&quot;PETSc&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">has_linear_algebra_backend</span><span class="p">(</span><span class="s2">&quot;Epetra&quot;</span><span class="p">):</span>
    <span class="n">info</span><span class="p">(</span><span class="s2">&quot;DOLFIN has not been configured with Trilinos or PETSc. Exiting.&quot;</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">()</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">has_krylov_solver_preconditioner</span><span class="p">(</span><span class="s2">&quot;amg&quot;</span><span class="p">):</span>
    <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sorry, this demo is only available when DOLFIN is compiled with AMG &quot;</span>
	 <span class="s2">&quot;preconditioner, Hypre or ML.&quot;</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">()</span>

<span class="k">if</span> <span class="n">has_krylov_solver_method</span><span class="p">(</span><span class="s2">&quot;minres&quot;</span><span class="p">):</span>
    <span class="n">krylov_method</span> <span class="o">=</span> <span class="s2">&quot;minres&quot;</span>
<span class="k">elif</span> <span class="n">has_krylov_solver_method</span><span class="p">(</span><span class="s2">&quot;tfqmr&quot;</span><span class="p">):</span>
    <span class="n">krylov_method</span> <span class="o">=</span> <span class="s2">&quot;tfqmr&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">info</span><span class="p">(</span><span class="s2">&quot;Default linear algebra backend was not compiled with MINRES or TFQMR &quot;</span>
         <span class="s2">&quot;Krylov subspace method. Terminating.&quot;</span><span class="p">)</span>
    <span class="n">exit</span><span class="p">()</span>

<span class="c1"># Load mesh</span>
<span class="n">mesh</span> <span class="o">=</span> <span class="n">UnitCubeMesh</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

<span class="c1"># Define function spaces</span>
<span class="n">V</span> <span class="o">=</span> <span class="n">VectorFunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">Q</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">W</span> <span class="o">=</span> <span class="n">V</span> <span class="o">*</span> <span class="n">Q</span>

<span class="c1"># Boundaries</span>
<span class="k">def</span> <span class="nf">right</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">DOLFIN_EPS</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">left</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">DOLFIN_EPS</span>
<span class="k">def</span> <span class="nf">top_bottom</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">on_boundary</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">DOLFIN_EPS</span> <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">DOLFIN_EPS</span>

<span class="c1"># No-slip boundary condition for velocity</span>
<span class="n">noslip</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
<span class="n">bc0</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">noslip</span><span class="p">,</span> <span class="n">top_bottom</span><span class="p">)</span>

<span class="c1"># Inflow boundary condition for velocity</span>
<span class="n">inflow</span> <span class="o">=</span> <span class="n">Expression</span><span class="p">((</span><span class="s2">&quot;-sin(x[1]*pi)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0&quot;</span><span class="p">))</span>
<span class="n">bc1</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">inflow</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>

<span class="c1"># Boundary condition for pressure at outflow</span>
<span class="n">zero</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">bc2</span> <span class="o">=</span> <span class="n">DirichletBC</span><span class="p">(</span><span class="n">W</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">zero</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>

<span class="c1"># Collect boundary conditions</span>
<span class="n">bcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">bc0</span><span class="p">,</span> <span class="n">bc1</span><span class="p">,</span> <span class="n">bc2</span><span class="p">]</span>

<span class="c1"># Define variational problem</span>
<span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">=</span> <span class="n">TrialFunctions</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
<span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span> <span class="o">=</span> <span class="n">TestFunctions</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">*</span><span class="n">dx</span> <span class="o">+</span> <span class="n">div</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">dx</span> <span class="o">+</span> <span class="n">q</span><span class="o">*</span><span class="n">div</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
<span class="n">L</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>

<span class="c1"># Form for use in constructing preconditioner matrix</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">grad</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">*</span><span class="n">dx</span> <span class="o">+</span> <span class="n">p</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="n">dx</span>

<span class="c1"># Assemble system</span>
<span class="n">A</span><span class="p">,</span> <span class="n">bb</span> <span class="o">=</span> <span class="n">assemble_system</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">bcs</span><span class="p">)</span>

<span class="c1"># Assemble preconditioner system</span>
<span class="n">P</span><span class="p">,</span> <span class="n">btmp</span> <span class="o">=</span> <span class="n">assemble_system</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">bcs</span><span class="p">)</span>

<span class="c1"># Create Krylov solver and AMG preconditioner</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">KrylovSolver</span><span class="p">(</span><span class="n">krylov_method</span><span class="p">,</span> <span class="s2">&quot;amg&quot;</span><span class="p">)</span>

<span class="c1"># Associate operator (A) and preconditioner matrix (P)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">set_operators</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>

<span class="c1"># Solve</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">W</span><span class="p">)</span>
<span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">vector</span><span class="p">(),</span> <span class="n">bb</span><span class="p">)</span>

<span class="c1"># Get sub-functions</span>
<span class="n">u</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">U</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

<span class="c1"># Save solution in VTK format</span>
<span class="n">ufile_pvd</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s2">&quot;velocity.pvd&quot;</span><span class="p">)</span>
<span class="n">ufile_pvd</span> <span class="o">&lt;&lt;</span> <span class="n">u</span>
<span class="n">pfile_pvd</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="s2">&quot;pressure.pvd&quot;</span><span class="p">)</span>
<span class="n">pfile_pvd</span> <span class="o">&lt;&lt;</span> <span class="n">p</span>

<span class="c1"># Plot solution</span>
<span class="n">plot</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<span class="n">plot</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">interactive</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../stokes-mini/python/documentation.html" class="btn btn-neutral float-right" title="20. Stokes equations with Mini elements" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../../singular-poisson/python/documentation.html" class="btn btn-neutral" title="18. Singular Poisson" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright FEniCS Project, https://fenicsproject.org.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'1.4.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>